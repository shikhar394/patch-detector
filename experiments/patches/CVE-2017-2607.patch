From 2527e66dd8f9dd23a2571f8bd8f2918edf6fc0cd Mon Sep 17 00:00:00 2001
From: Jesse Glick <jglick@cloudbees.com>
Date: Wed, 25 Jan 2017 13:23:21 -0500
Subject: [PATCH] [SECURITY-382] Be more compatible with maven-plugin.

---
 core/src/main/java/hudson/console/ConsoleNote.java | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/core/src/main/java/hudson/console/ConsoleNote.java b/core/src/main/java/hudson/console/ConsoleNote.java
index f44b7b6db6a..d80713762f4 100644
--- a/core/src/main/java/hudson/console/ConsoleNote.java
+++ b/core/src/main/java/hudson/console/ConsoleNote.java
@@ -191,9 +191,11 @@ private ByteArrayOutputStream encodeToBytes() throws IOException {
         DataOutputStream dos = new DataOutputStream(new Base64OutputStream(buf2,true,-1,null));
         try {
             buf2.write(PREAMBLE);
-            byte[] mac = MAC.mac(buf.toByteArray());
-            dos.writeInt(- mac.length); // negative to differentiate from older form
-            dos.write(mac);
+            if (Jenkins.getInstance() != null) { // else we are in another JVM and cannot sign; TODO 1.653+ use getInstanceOrNull
+                byte[] mac = MAC.mac(buf.toByteArray());
+                dos.writeInt(- mac.length); // negative to differentiate from older form
+                dos.write(mac);
+            }
             dos.writeInt(buf.size());
             buf.writeTo(dos);
         } finally {